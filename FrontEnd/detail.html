<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        #contentArea{
            width: 500px;
            min-height: 500px;
            border: 1px solid;
        }
        img{
            width: 300px;
            height: auto;
        }
        .unable{
            display: none;
        }
    </style>
</head>
<body>
    <h1>글 보기</h1>    
    <label for="">제목</label>
    <input type="text" id="title" disabled>
    <label for="">작성자</label>
    <input type="text" id="nickname" disabled><br>
    <label for="">본문</label>
    <div id="contentArea"></div>
    <div id="updateBtn">
        <button id="toUpdate">수정</button><button id="toDelete">삭제</button>
    </div>
    <button id="likeBtn">좋아요</button> <input type="text" id="postLikes" disabled>
    <a href="3.38.119.154/post"><button id="toPost">글 목록</button></a>
</body>
<script>
    axios.defaults.withCredentials = true;
    let posts = {};
    let users = {};
    let likeNum = [];
    async function GetAPI(){
        try {
            const {data} = await axios.get('3.35.211.37/post/detail',{
                headers : {
                    "Content-Type" : "application/json"
                }
            }) 
            title.value = data.posts.title;
            nickname.value = data.posts.User.nickname;
            contentArea.innerHTML = data.posts.content;
            
            if(data.posts.postLikes != null && data.posts.postLikes != 'null'){
                likeNum = data.posts.postLikes.split(',');
                postLikes.value = likeNum.length;
            }else{
                postLikes.value = 0;
            }            
            
            posts = data.posts;
            users = data.users;

            console.log(posts);

            if(data.users.id != data.posts.userId){
                updateBtn.classList.add('unable');
            }else{
                updateBtn.classList.remove('unable');
            }
            

        } catch (error) {
            console.log(error);
        }
    }

    GetAPI();    

    toUpdate.onclick = async()=>{
        try {
            await axios.post('3.35.211.37/post/updateview',{
                headers : {
                    "Content-Type" : "application/json"
                },
                data : posts.id
            }).then((e)=>{
                location.href = e.data;
            }).catch((err)=>{
                console.log(err);
            })
        } catch (error) {
            console.log(error);
        }
    }

    toDelete.onclick = async()=>{
        try {
            await axios.post('3.35.211.37/post/delete',{
                headers : {
                    "Content-Type" : "application/json"
                },
                data : posts.id
            }).then((e)=>{
                location.href = e.data;
            }).catch((err)=>{
                console.log(err);
            })
        } catch (error) {
            console.log(error);
        }
    }

    likeBtn.onclick = async()=>{
        try {
            if(posts.userId != users.id){                
                let likeUser = [];
    
                if(posts.postLikes == null || posts.postLikes == 'null'){
                    posts.postLikes = users.id.toString();
                    likeUser.push(posts.postLikes);
                }else{
                    likeUser = posts.postLikes.split(",");
    
                    if(!likeUser.includes(users.id.toString())){
                        likeUser.push(users.id.toString());
                        posts.postLikes = likeUser.join(',');                    
                    }else{
                        likeUser.splice(likeUser.indexOf(users.id.toString()),1);
                        if(likeUser.length == 0){
                            posts.postLikes = null;
                        }else{
                            posts.postLikes = likeUser.join(',');
                        }
                    }
                }
    
                postLikes.value = likeUser.length;
    
                const form = new FormData();
    
                form.append('id',posts.id);
                form.append('postLikes',posts.postLikes);
                
                await axios.post('3.35.211.37/post/likes',form,{
                    headers : {
                        "Content-Type" : "application/json"
                    }
                })
            }
        } catch (error) {
            console.log(error);
        }
    }
</script>
</html>